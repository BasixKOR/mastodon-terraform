machine:
  environment:
    DOCKER_IMAGE_NAME_AND_TAG: hashicorp/terraform:0.9.3
  services:
    - docker
database:
  override:
    - echo "Skip database phase"
dependencies:
  override:
    - docker pull ${DOCKER_IMAGE_NAME_AND_TAG}
    - echo AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} >> .env
    - echo AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} >> .env
    - echo TF_VAR_aws_launch_configuration_ami_id=${TF_VAR_aws_launch_configuration_ami_id} >> .env
    - echo TF_VAR_aws_region=${TF_VAR_aws_region} >> .env
    - echo TF_VAR_mastodon_db_pass=${TF_VAR_mastodon_db_pass} >> .env
    - echo TF_VAR_mastodon_db_user=${TF_VAR_mastodon_db_user} >> .env
    - echo TF_VAR_mastodon_docker_image_tag=${TF_VAR_mastodon_docker_image_tag} >> .env
    - echo TF_VAR_mastodon_secret_key_base=${TF_VAR_mastodon_secret_key_base} >> .env
    - >
      docker run --env-file .env --volume $(pwd)/terraform:/app/terraform --workdir /app/terraform ${DOCKER_IMAGE_NAME_AND_TAG} init \
        -backend=true \
        -backend-config="bucket=${AWS_S3_BUCKET_TERRAFORM_STATE_NAME}" \
        -backend-config="key=${AWS_S3_BUCKET_TERRAFORM_STATE_KEY}" \
        -backend-config="region=${AWS_S3_BUCKET_TERRAFORM_STATE_REGION}"
deployment:
  master:
    branch: master
    commands:
      - git clone https://github.com/tootsuite/mastodon.git
      - docker build --file ./docker/rails/Dockerfile --tag mastodon_rails_without_assets ./mastodon
      - docker run --env RAILS_ENV=production --volume $(pwd)/public/assets:/app/public/assets mastodon_rails_without_assets bundle exec rake assets:precompile
      - docker build --file ./docker/rails/Dockerfile --tag ${DOCKER_REPOSITORY_URL_RAILS}:${CIRCLE_BUILD_NUM} ./mastodon
      - docker build --file ./docker/node/Dockerfile --tag ${DOCKER_REPOSITORY_URL_NODE}:${CIRCLE_BUILD_NUM} ./mastodon
      - eval $(aws ecr get-login --region ${AWS_REGION})
      - docker push ${DOCKER_REPOSITORY_URL_NODE}:${CIRCLE_BUILD_NUM}
      - docker push ${DOCKER_REPOSITORY_URL_RAILS}:${CIRCLE_BUILD_NUM}
      - docker run --env-file .env --volume $(pwd)/terraform:/app/terraform --workdir /app/terraform ${DOCKER_IMAGE_NAME_AND_TAG} apply
test:
  override:
    - docker run --env-file .env --volume $(pwd)/terraform:/app/terraform --workdir /app/terraform ${DOCKER_IMAGE_NAME_AND_TAG} plan
