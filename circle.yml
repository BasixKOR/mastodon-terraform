machine:
  environment:
    TERRAFORM_DOCKER_IMAGE_NAME: hashicorp/terraform:0.9.3
  services:
    - docker
database:
  override:
    - echo "Skip database phase"
dependencies:
  override:
    - docker pull ${TERRAFORM_DOCKER_IMAGE_NAME}
    - echo AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} >> .env
    - echo AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} >> .env
    - echo TF_VAR_aws_launch_configuration_ami_id=${TF_VAR_aws_launch_configuration_ami_id} >> .env
    - echo TF_VAR_aws_region=${TF_VAR_aws_region} >> .env
    - echo TF_VAR_mastodon_db_pass=${TF_VAR_mastodon_db_pass} >> .env
    - echo TF_VAR_mastodon_db_user=${TF_VAR_mastodon_db_user} >> .env
    - echo TF_VAR_mastodon_docker_image_tag=${TF_VAR_mastodon_docker_image_tag} >> .env
    - echo TF_VAR_mastodon_secret_key_base=${TF_VAR_mastodon_secret_key_base} >> .env
    - >
      docker run --env-file .env --volume $(pwd)/terraform:/app/terraform --workdir /app/terraform ${TERRAFORM_DOCKER_IMAGE_NAME} init \
        -backend=true \
        -backend-config="bucket=${AWS_S3_BUCKET_TERRAFORM_STATE_NAME}" \
        -backend-config="key=${AWS_S3_BUCKET_TERRAFORM_STATE_KEY}" \
        -backend-config="region=${AWS_S3_BUCKET_TERRAFORM_STATE_REGION}"
deployment:
  master:
    branch: master
    commands:
      - docker run --env-file .env --volume $(pwd)/terraform:/app/terraform --workdir /app/terraform ${TERRAFORM_DOCKER_IMAGE_NAME} apply
      - git clone https://github.com/tootsuite/mastodon.git
      - docker build --tag mastodon mastodon
      - docker run --env SECRET_KEY_BASE=dummy --volume $(pwd)/mastodon/public/assets:/mastodon/public/assets mastodon bundle exec rake assets:precompile
      - rm mastodon/.dockerignore
      - docker build --tag ${MASTODON_DOCKER_IMAGE_REPOSITORY_URL}:${CIRCLE_BUILD_NUM} mastodon
      - eval $(aws ecr get-login --region ${AWS_REGION})
      - docker push ${MASTODON_DOCKER_IMAGE_REPOSITORY_URL}:${CIRCLE_BUILD_NUM}
test:
  override:
    - docker run --env-file .env --volume $(pwd)/terraform:/app/terraform --workdir /app/terraform ${TERRAFORM_DOCKER_IMAGE_NAME} plan
